<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Draw a Polygon</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.css" />
    <!-- Leaflet Draw CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
</head>
<body>
    <h1>Draw a Polygon</h1>

    <!-- Map container -->
    <div id="map" style="height: 400px;"></div>

    <!-- Year selection -->
    <label for="startYear">Start Year:</label>
    <input type="number" id="startYear" name="startYear" min="1984" placeholder="Minimum: 1984" required>

    <label for="endYear">End Year:</label>
    <input type="number" id="endYear" name="endYear" required>

    <!-- Control buttons -->
    <button id="clearPolygon">Clear Polygon</button>
    <button id="confirmPolygon">Confirm and Clip</button>

    <!-- Leaflet JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.js"></script>
    <!-- Leaflet Draw JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>

    <script>
        let maxYear = 2024;  // This will be updated dynamically from the server

        // Fetch the maximum available RPMS year from the server
        fetch('/get_max_rpms_year')
            .then(response => response.json())
            .then(data => {
                maxYear = data.max_year;
                document.getElementById('endYear').max = maxYear;
                document.getElementById('endYear').placeholder = `Max Year: ${maxYear}`;
            });

        let map = L.map('map').setView([37.7749, -122.4194], 6);  // Set view to Northern California with zoom level 6
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Map data Â© OpenStreetMap contributors'
        }).addTo(map);

        let drawnPolygon = null;
        let drawnLayer = new L.FeatureGroup().addTo(map);

        let drawControl = new L.Control.Draw({
            draw: {
                polygon: true,
                polyline: false,
                rectangle: false,
                circle: false,
                marker: false,
            },
            edit: {
                featureGroup: drawnLayer,
                remove: true
            }
        }).addTo(map);

        map.on(L.Draw.Event.CREATED, function (e) {
            if (drawnPolygon) {
                drawnLayer.clearLayers();  // Clear previous polygons
            }
            drawnPolygon = e.layer;
            drawnLayer.addLayer(drawnPolygon);
        });

        document.getElementById('clearPolygon').addEventListener('click', function () {
            drawnLayer.clearLayers();
            drawnPolygon = null;
        });

        document.getElementById('confirmPolygon').addEventListener('click', function () {
            if (drawnPolygon) {
                // Get the polygon coordinates
                let polygonCoords = drawnPolygon.toGeoJSON().geometry.coordinates;

                // Validate year inputs
                const startYear = parseInt(document.getElementById('startYear').value);
                const endYear = parseInt(document.getElementById('endYear').value);

                if (startYear < 1984 || endYear < startYear || endYear > maxYear) {
                    alert(`Please enter a valid year range between 1984 and ${maxYear}.`);
                    return;
                }

                // Send polygon coordinates, start year, and end year to the server
                fetch('/clip_raster', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        polygon_coords: polygonCoords,
                        startYear: startYear,
                        endYear: endYear
                    })
                })
                .then(response => response.json())
                .then(data => {
                    console.log("Clipping response:", data);
                    if (data.message === 'Clipping complete') {
                        window.location.href = '/result';  // Redirect to result screen
                    } else {
                        alert('Error during clipping: ' + data.error);
                    }
                });
            } else {
                alert('Please draw a polygon first!');
            }
        });
    </script>
</body>
</html>
